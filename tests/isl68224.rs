use commands::isl68224::*;
use pmbus::*;

fn mode() -> VOutModeCommandData {
    VOutModeCommandData::from_slice(&[0x40]).unwrap()
}

fn dump_data(
    val: u32,
    width: Bitwidth,
    v: &mut std::vec::Vec<((Bitpos, Bitwidth), &str, std::string::String)>,
) {
    let width = width.0 as usize;
    let nibble = 4;
    let maxwidth = 32;

    if width > maxwidth {
        std::println!("{:?}", v);
        return;
    }

    let indent = (maxwidth - width) + ((maxwidth - width) / nibble);

    std::print!("{:indent$}", "", indent = indent);
    std::print!("0b");

    for v in (0..width).step_by(nibble) {
        std::print!(
            "{:04b}{}",
            (val >> ((width - nibble) - v)) & 0xf,
            if v + nibble < width { "_" } else { "\n" }
        )
    }

    while v.len() > 0 {
        let mut cur = width - 1;

        std::print!("{:indent$}", "", indent = indent);
        std::print!("  ");

        for i in 0..v.len() {
            while cur > v[i].0 .0 .0 as usize {
                if cur % nibble == 0 {
                    std::print!(" ");
                }

                std::print!(" ");
                cur -= 1;
            }

            if i < v.len() - 1 {
                std::print!("|");

                if cur % nibble == 0 {
                    std::print!(" ");
                }

                cur -= 1;
            } else {
                std::print!("+--");

                while cur > 0 {
                    std::print!("-");

                    if cur % nibble == 0 {
                        std::print!("-");
                    }

                    cur -= 1;
                }

                std::println!(" {} = {}", v[i].1, v[i].2);
            }
        }

        v.pop();
    }
}

fn dump(data: &impl CommandData) {
    let (val, width) = data.raw();
    let mut v = std::vec![];

    data.interpret(mode, |field, value| {
        v.push((field.bits(), field.desc(), std::format!("{}", value)));
    })
    .unwrap();

    dump_data(val, width, &mut v);
}

struct RenesasBlackbox {
    rail0_uptime: UptimeCounter::CommandData,
    rail1_uptime: UptimeCounter::CommandData,
    rail2_uptime: UptimeCounter::CommandData,
    controller_first_fault: ControllerFault::CommandData,
    rail0_first_fault: RailFault::CommandData,
    rail1_first_fault: RailFault::CommandData,
    rail2_first_fault: RailFault::CommandData,
    rail0_status: STATUS_WORD::CommandData,
    rail1_status: STATUS_WORD::CommandData,
    rail2_status: STATUS_WORD::CommandData,
    cml_status: STATUS_CML::CommandData,
    mfr_specific: STATUS_MFR_SPECIFIC::CommandData,
    rail0_vout_status: STATUS_VOUT::CommandData,
    rail1_vout_status: STATUS_VOUT::CommandData,
    rail2_vout_status: STATUS_VOUT::CommandData,
    rail0_iout_status: STATUS_IOUT::CommandData,
    rail1_iout_status: STATUS_IOUT::CommandData,
    rail2_iout_status: STATUS_IOUT::CommandData,
    rail0_temp_status: STATUS_TEMPERATURE::CommandData,
    rail1_temp_status: STATUS_TEMPERATURE::CommandData,
    rail2_temp_status: STATUS_TEMPERATURE::CommandData,
    rail0_input_status: STATUS_INPUT::CommandData,
    rail1_input_status: STATUS_INPUT::CommandData,
    rail2_input_status: STATUS_INPUT::CommandData,
    rail0_vin: READ_VIN::CommandData,
    rail1_vin: READ_VIN::CommandData,
    rail2_vin: READ_VIN::CommandData,
    rail0_vout: READ_VOUT::CommandData,
    rail1_vout: READ_VOUT::CommandData,
    rail2_vout: READ_VOUT::CommandData,
    rail0_iin: READ_IIN::CommandData,
    rail1_iin: READ_IIN::CommandData,
    rail2_iin: READ_IIN::CommandData,
    rail0_iout: READ_IOUT::CommandData,
    rail1_iout: READ_IOUT::CommandData,
    rail2_iout: READ_IOUT::CommandData,
}

macro_rules! bb_field {
    ($slice:expr, $cmd:tt, $word:expr, $offs:expr) => {
        $cmd::CommandData::from_slice(&$slice[($word * 4) + $offs..]).unwrap()
    };
}

impl RenesasBlackbox {
    fn from_slice(buf: &[u8]) -> Self {
        Self {
            rail0_uptime: bb_field!(buf, UptimeCounter, 1, 0),
            rail1_uptime: bb_field!(buf, UptimeCounter, 2, 0),
            rail2_uptime: bb_field!(buf, UptimeCounter, 3, 0),
            controller_first_fault: bb_field!(buf, ControllerFault, 4, 0),
            rail0_first_fault: bb_field!(buf, RailFault, 5, 0),
            rail1_first_fault: bb_field!(buf, RailFault, 6, 0),
            rail2_first_fault: bb_field!(buf, RailFault, 7, 0),
            rail0_status: bb_field!(buf, STATUS_WORD, 11, 0),
            rail1_status: bb_field!(buf, STATUS_WORD, 12, 2),
            rail2_status: bb_field!(buf, STATUS_WORD, 12, 0),
            cml_status: bb_field!(buf, STATUS_CML, 13, 3),
            mfr_specific: bb_field!(buf, STATUS_MFR_SPECIFIC, 13, 2),
            rail0_vout_status: bb_field!(buf, STATUS_VOUT, 13, 1),
            rail1_vout_status: bb_field!(buf, STATUS_VOUT, 13, 0),
            rail2_vout_status: bb_field!(buf, STATUS_VOUT, 14, 3),
            rail0_iout_status: bb_field!(buf, STATUS_IOUT, 14, 2),
            rail1_iout_status: bb_field!(buf, STATUS_IOUT, 14, 1),
            rail2_iout_status: bb_field!(buf, STATUS_IOUT, 14, 0),
            rail0_temp_status: bb_field!(buf, STATUS_TEMPERATURE, 15, 3),
            rail1_temp_status: bb_field!(buf, STATUS_TEMPERATURE, 15, 2),
            rail2_temp_status: bb_field!(buf, STATUS_TEMPERATURE, 15, 1),
            rail0_input_status: bb_field!(buf, STATUS_INPUT, 15, 3),
            rail1_input_status: bb_field!(buf, STATUS_INPUT, 16, 3),
            rail2_input_status: bb_field!(buf, STATUS_INPUT, 16, 2),
            rail0_vin: bb_field!(buf, READ_VIN, 16, 0),
            rail1_vin: bb_field!(buf, READ_VIN, 17, 2),
            rail2_vin: bb_field!(buf, READ_VIN, 17, 0),
            rail0_vout: bb_field!(buf, READ_VOUT, 18, 2),
            rail1_vout: bb_field!(buf, READ_VOUT, 18, 0),
            rail2_vout: bb_field!(buf, READ_VOUT, 19, 2),
            rail0_iin: bb_field!(buf, READ_IIN, 19, 0),
            rail1_iin: bb_field!(buf, READ_IIN, 20, 2),
            rail2_iin: bb_field!(buf, READ_IIN, 20, 0),
            rail0_iout: bb_field!(buf, READ_IOUT, 21, 2),
            rail1_iout: bb_field!(buf, READ_IOUT, 21, 0),
            rail2_iout: bb_field!(buf, READ_IOUT, 22, 2),
        }
    }

    fn dump(&self) {
        dump(&self.rail0_uptime);
        dump(&self.rail1_uptime);
        dump(&self.rail2_uptime);
        dump(&self.controller_first_fault);
        dump(&self.rail0_first_fault);
        dump(&self.rail1_first_fault);
        dump(&self.rail2_first_fault);
        dump(&self.rail0_status);
        dump(&self.rail1_status);
        dump(&self.rail2_status);
        dump(&self.cml_status);
        dump(&self.mfr_specific);
        dump(&self.rail0_vout_status);
        dump(&self.rail1_vout_status);
        dump(&self.rail2_vout_status);

        dump(&self.rail0_iout_status);
        dump(&self.rail1_iout_status);
        dump(&self.rail2_iout_status);

        dump(&self.rail0_temp_status);
        dump(&self.rail1_temp_status);
        dump(&self.rail2_temp_status);

        dump(&self.rail0_input_status);
        dump(&self.rail1_input_status);
        dump(&self.rail2_input_status);

        dump(&self.rail0_vin);
        dump(&self.rail1_vin);
        dump(&self.rail2_vin);

        dump(&self.rail0_vout);
        dump(&self.rail1_vout);
        dump(&self.rail2_vout);

        dump(&self.rail0_iin);
        dump(&self.rail1_iin);
        dump(&self.rail2_iin);

        dump(&self.rail0_iout);
        dump(&self.rail1_iout);
        dump(&self.rail2_iout);
    }
}

#[test]
fn blackbox_test4() {
    let raw = [
        0x00, 0x00, 0x00, 0x00, 0x83, 0x48, 0x01, 0x00, 0x33, 0x4c, 0x01, 0x00,
        0x33, 0x4c, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x58, 0x00, 0x00,
        0x03, 0x10, 0x03, 0x10, 0x00, 0x00, 0x08, 0xa2, 0x00, 0x00, 0x80, 0x00,
        0x00, 0x00, 0x00, 0x00, 0xab, 0x04, 0x00, 0x00, 0xab, 0x04, 0xab, 0x04,
        0xe7, 0x03, 0x84, 0x03, 0x04, 0x00, 0xb0, 0x04, 0x02, 0x00, 0x03, 0x00,
        0x02, 0x00, 0x00, 0x00, 0x0e, 0x0e, 0x02, 0x00, 0x00, 0x00, 0x0c, 0x0f,
        0x00, 0x00, 0x00, 0x00, 0xe9, 0x01, 0xac, 0x04, 0x0f, 0x00, 0x00, 0x00,
        0x0e, 0x0e, 0x0e, 0x0e, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x42, 0xff, 0x80,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    ];

    let bb = RenesasBlackbox::from_slice(&raw);
    bb.dump();
}

#[test]
fn blackbox_test7() {
    let raw = [
        0x00, 0x00, 0x00, 0x00, 0x0c, 0x05, 0x00, 0x00, 0x93, 0x0a, 0x00, 0x00,
        0x93, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x58, 0x00, 0x00,
        0x01, 0x10, 0x01, 0x10, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x80, 0x00,
        0x00, 0x00, 0x00, 0x00, 0xab, 0x04, 0x00, 0x00, 0xaa, 0x04, 0xaa, 0x04,
        0xe8, 0x03, 0x84, 0x03, 0x04, 0x00, 0xaf, 0x04, 0x02, 0x00, 0x03, 0x00,
        0x02, 0x00, 0x02, 0x00, 0x0e, 0x0e, 0x02, 0x00, 0x00, 0x00, 0x0c, 0x0f,
        0x00, 0x00, 0x00, 0x00, 0xe9, 0x01, 0xae, 0x04, 0x0f, 0x00, 0x00, 0x00,
        0x0e, 0x0e, 0x0e, 0x0e, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00,
        0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0xaa, 0xff, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    ];
    let bb = RenesasBlackbox::from_slice(&raw);
    bb.dump();
}

#[test]
fn blackbox_test8() {
    let raw = [
        0x00, 0x00, 0x00, 0x00, 0x0c, 0x05, 0x00, 0x00, 0x2f, 0x1f, 0x00, 0x00,
        0x2f, 0x1f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x11, 0x58, 0x00, 0x00,
        0x01, 0x10, 0x01, 0x10, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x80, 0x00,
        0x00, 0x00, 0x00, 0x00, 0xab, 0x04, 0x00, 0x00, 0xaa, 0x04, 0xaa, 0x04,
        0xe8, 0x03, 0x84, 0x03, 0x04, 0x00, 0xaf, 0x04, 0x02, 0x00, 0x03, 0x00,
        0x02, 0x00, 0x02, 0x00, 0x0e, 0x0e, 0x02, 0x00, 0x00, 0x00, 0x0c, 0x0f,
        0x00, 0x00, 0x00, 0x00, 0xe9, 0x01, 0xae, 0x04, 0x0f, 0x00, 0x00, 0x00,
        0x0e, 0x0e, 0x0e, 0x0e, 0x00, 0x00, 0x00, 0x0e, 0x00, 0x00, 0x00, 0x00,
        0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0xaa, 0xff, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    ];

    let bb = RenesasBlackbox::from_slice(&raw);

    bb.dump();
    println!("{:?}", bb.rail0_vin.get().unwrap());
    assert_eq!(bb.rail0_vin.get(), Ok(units::Volts(11.950001)));
}
